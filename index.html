<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Smash Ultimate+</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;background:#111;color:#fff;font-family:sans-serif;overflow:hidden;}
.screen{display:none;justify-content:center;align-items:center;flex-direction:column;height:100vh;}
button{padding:10px 16px;margin:6px;font-size:16px;}
#game{position:relative;width:100vw;height:100vh;background:#222;}
.player{position:absolute;width:40px;height:40px;border-radius:6px;}
#p1{background:red;}
#p2{background:cyan;}
.stage{position:absolute;bottom:40px;left:5%;width:90%;height:20px;background:#555;}
.hp{position:absolute;top:5px;font-size:16px;}
.guard{outline:3px solid cyan;}
.break{outline:3px solid red;}
</style>
</head>

<body>

<div id="title" class="screen" style="display:flex">
<h1>Mini Smash</h1>
<button onclick="mode='cpu';show('select')">CPU対戦</button>
<button onclick="mode='pvp';show('select')">2P対戦</button>
</div>

<div id="select" class="screen">
<h2>キャラ選択</h2>
<button onclick="selectChar(1,'speed')">P1 Speed</button>
<button onclick="selectChar(1,'power')">P1 Power</button>
<button onclick="selectChar(1,'balance')">P1 Balance</button>

<div id="cpuSelect">
<h3>CPUレベル</h3>
<button onclick="cpuLevel=1">Easy</button>
<button onclick="cpuLevel=2">Normal</button>
<button onclick="cpuLevel=3">Hard</button>
<button onclick="cpuLevel=4">Insane</button>
</div>

<button onclick="startGame()">START</button>
</div>

<div id="game">
<div class="stage"></div>
<div id="p1" class="player"></div>
<div id="p2" class="player"></div>
<div id="hp1" class="hp"></div>
<div id="hp2" class="hp" style="right:10px"></div>
</div>

<script>
let mode="cpu";
let cpuLevel=1;

const chars={
 speed:{speed:6,power:0.8},
 power:{speed:3,power:1.6},
 balance:{speed:4.5,power:1}
};

let p1={x:200,y:300,vx:0,vy:0,percent:0,stock:3,guard:100,air:false,char:null};
let p2={x:500,y:300,vx:0,vy:0,percent:0,stock:3,guard:100,air:false,char:null};

function show(id){
 document.querySelectorAll('.screen').forEach(s=>s.style.display='none');
 document.getElementById(id).style.display='flex';
}

function selectChar(p,c){
 (p===1?p1:p2).char=chars[c];
}

function startGame(){
 if(!p1.char) p1.char=chars.balance;
 if(!p2.char) p2.char=chars.balance;
 show("game");
 loop();
}

// ================= 攻撃処理 =================
function attack(att,def,power){
 if(Math.abs(att.x-def.x)<60){
  if(def.guard>0){
    def.guard-=15;
  }else{
    def.percent+=power;
    def.vy=-8;
  }
 }
}

// ================= CPU AI =================
function cpuAI(){
 let a=p2,b=p1;
 let d=b.x-a.x;

 // 移動
 if(Math.abs(d)>60){
   a.vx=Math.sign(d)*a.char.speed;
 }else{
   a.vx=0;
 }

 // ジャンプ回避
 if(cpuLevel>=3 && Math.random()<0.02 && !a.air){
   a.vy=-10;
 }

 // 攻撃頻度
 let atkRate=[0.005,0.015,0.03,0.06][cpuLevel-1];
 if(Math.random()<atkRate){
   attack(a,b,10*a.char.power);
 }

 // ガード
 if(cpuLevel>=2 && Math.random()<0.02){
   a.guard=50;
 }
}

// ================= ループ =================
function loop(){
 if(mode==="cpu") cpuAI();

 [p1,p2].forEach(p=>{
  p.vy+=0.6;
  p.x+=p.vx;
  p.y+=p.vy;

  if(p.y>300){p.y=300;p.vy=0;p.air=false;}
 });

 // 落下
 [p1,p2].forEach(p=>{
  if(p.y>600||p.x<-200||p.x>innerWidth+200){
    p.stock--;
    p.x=innerWidth/2;
    p.y=200;
    p.percent=0;
  }
 });

 if(p1.stock<=0){alert("YOU LOSE");location.reload();}
 if(p2.stock<=0){alert("YOU WIN");location.reload();}

 document.getElementById("p1").style.left=p1.x+"px";
 document.getElementById("p1").style.top=p1.y+"px";
 document.getElementById("p2").style.left=p2.x+"px";
 document.getElementById("p2").style.top=p2.y+"px";

 document.getElementById("hp1").innerText=`P1 ❤${p1.stock} ${Math.floor(p1.percent)}%`;
 document.getElementById("hp2").innerText=`P2 ❤${p2.stock} ${Math.floor(p2.percent)}%`;

 requestAnimationFrame(loop);
}
</script>
</body>
</html>
